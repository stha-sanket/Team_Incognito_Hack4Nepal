{% extends 'core/base.html' %}

{% block title %}Dashboard - D-Ask{% endblock %}

{% block extra_css %}
<style>
.dashboard-stats {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border-radius: 15px;
    transition: all 0.3s ease;
}

.dashboard-stats:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.stat-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    margin-bottom: 1rem;
}

.application-list {
    max-height: 400px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

.application-list::-webkit-scrollbar {
    width: 6px;
}

.application-list::-webkit-scrollbar-track {
    background: transparent;
}

.application-list::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: 500;
}

.status-pending {
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.status-approved {
    background-color: rgba(76, 175, 80, 0.1);
    color: #4caf50;
}

.status-rejected {
    background-color: rgba(244, 67, 54, 0.1);
    color: #f44336;
}

.application-details {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1rem;
    margin-top: 1rem;
}

.application-details dl {
    margin-bottom: 0;
}

.application-details dt {
    font-weight: 600;
    color: #666;
}

.application-details dd {
    margin-bottom: 0.5rem;
}

.chart-container {
    position: relative;
    margin: auto;
    height: 300px;
}

.progress-ring {
    transform: rotate(-90deg);
}

.progress-ring-circle {
    transition: stroke-dashoffset 0.35s;
    transform: rotate(-90deg);
    transform-origin: 50% 50%;
}

/* Add Modal Styles */
.modal-content {
    border: none;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.modal-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
}

.btn-approve {
    background-color: #4caf50;
    color: white;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: 25px;
    transition: all 0.3s ease;
}

.btn-approve:hover {
    background-color: #43a047;
    transform: translateY(-2px);
}

.btn-reject {
    background-color: #f44336;
    color: white;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: 25px;
    transition: all 0.3s ease;
}

.btn-reject:hover {
    background-color: #e53935;
    transform: translateY(-2px);
}

.status-message {
    padding: 1rem;
    border-radius: 10px;
    margin-top: 1rem;
    display: none;
}

.status-message.success {
    background-color: rgba(76, 175, 80, 0.1);
    color: #4caf50;
    border: 1px solid rgba(76, 175, 80, 0.2);
}

.status-message.error {
    background-color: rgba(244, 67, 54, 0.1);
    color: #f44336;
    border: 1px solid rgba(244, 67, 54, 0.2);
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container py-5 mt-5">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 bg-primary text-white overflow-hidden" style="background: linear-gradient(45deg, #1976D2, #64B5F6);">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h2 class="fw-bold mb-3">Welcome back, {{ user.username }}!</h2>
                            <p class="mb-4">Here's what's happening with your applications</p>
                            <a href="{% url 'citizenship' %}" class="btn btn-light btn-lg ripple-surface">
                                <i class="fas fa-plus me-2"></i>New Application
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="dashboard-stats p-4">
                <div class="stat-icon bg-primary bg-opacity-10">
                    <i class="fas fa-file-alt fa-2x text-primary"></i>
                </div>
                <h3 class="h2 mb-2">{{ total_applications }}</h3>
                <p class="text-muted mb-0">Total Applications</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dashboard-stats p-4">
                <div class="stat-icon bg-warning bg-opacity-10">
                    <i class="fas fa-clock fa-2x text-warning"></i>
                </div>
                <h3 class="h2 mb-2">{{ pending_applications }}</h3>
                <p class="text-muted mb-0">Pending</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dashboard-stats p-4">
                <div class="stat-icon bg-success bg-opacity-10">
                    <i class="fas fa-check-circle fa-2x text-success"></i>
                </div>
                <h3 class="h2 mb-2">{{ approved_applications }}</h3>
                <p class="text-muted mb-0">Approved</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dashboard-stats p-4">
                <div class="stat-icon bg-danger bg-opacity-10">
                    <i class="fas fa-times-circle fa-2x text-danger"></i>
                </div>
                <h3 class="h2 mb-2">{{ rejected_applications }}</h3>
                <p class="text-muted mb-0">Rejected</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Recent Applications -->
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Recent Applications</h4>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="application-list">
                        {% for application in applications %}
                        <div class="p-4 border-bottom application-item">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-1">{{ application.type|title }}</h5>
                                    <p class="text-muted mb-0">Application ID: {{ application.pk }}</p>
                                    <p class="text-muted mb-0">Full Name: {{ application.full_name }}</p>
                                </div>
                                <div class="col-md-3">
                                    <span class="status-badge status-{{ application.status|lower }}">
                                        {{ application.status|title }}
                                    </span>
                                </div>
                                <div class="col-md-3 text-md-end">
                                    <span class="d-none debug-info">App ID: {{ application.pk }}</span>
                                    <button class="btn btn-outline-primary btn-sm view-details" 
                                            data-application-id="{{ application.pk }}"
                                            data-application-type="{{ application.type }}"
                                            data-application-status="{{ application.status }}"
                                            data-application-name="{{ application.full_name }}"
                                            data-application-sex="{{ application.sex }}"
                                            data-application-birth="{{ application.birth_day }}/{{ application.birth_month }}/{{ application.birth_year }}"
                                            data-application-date="{{ application.created_at|date:'d M Y, h:i A' }}">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center p-4">
                            <img src="https://cdn.jsdelivr.net/gh/ashuranoryoshi/d-ask-assets@main/empty-state.svg" alt="No applications" class="img-fluid mb-3" style="max-height: 200px;">
                            <h5>No Applications Yet</h5>
                            <p class="text-muted">Start by creating your first application</p>
                            <a href="{% url 'citizenship' %}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>New Application
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Application Details Modal -->
<div class="modal fade" id="applicationModal" tabindex="-1" aria-labelledby="applicationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="applicationModalLabel">Application Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Application Type</dt>
                    <dd class="col-sm-8" id="modalType"></dd>
                    
                    <dt class="col-sm-4">Status</dt>
                    <dd class="col-sm-8" id="modalStatus"></dd>
                    
                    <dt class="col-sm-4">Full Name</dt>
                    <dd class="col-sm-8" id="modalName"></dd>
                    
                    <dt class="col-sm-4">Gender</dt>
                    <dd class="col-sm-8" id="modalSex"></dd>
                    
                    <dt class="col-sm-4">Date of Birth</dt>
                    <dd class="col-sm-8" id="modalBirth"></dd>
                    
                    <dt class="col-sm-4">Submitted On</dt>
                    <dd class="col-sm-8" id="modalDate"></dd>
                </dl>
                <div class="status-message" id="statusMessage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-approve" id="approveBtn">
                    <i class="fas fa-check me-2"></i>Approve
                </button>
                <button type="button" class="btn btn-reject" id="rejectBtn">
                    <i class="fas fa-times me-2"></i>Reject
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Get the modal element
        const modalElement = document.getElementById('applicationModal');
        if (!modalElement) {
            console.error('Modal element not found');
            return;
        }
        
        const modal = new bootstrap.Modal(modalElement);
        let currentApplicationId = null;

        // Handle view details button click
        document.querySelectorAll('.view-details').forEach(button => {
            button.addEventListener('click', function(e) {
                try {
                    e.preventDefault();
                    const data = this.dataset;
                    currentApplicationId = parseInt(data.applicationId, 10); // Convert to integer
                    
                    // Debug logs
                    console.log('Button clicked');
                    console.log('Dataset:', {
                        id: currentApplicationId,
                        type: data.applicationType,
                        status: data.applicationStatus,
                        name: data.applicationName
                    });
                    
                    // Populate modal with application details
                    document.getElementById('modalType').textContent = data.applicationType.charAt(0).toUpperCase() + data.applicationType.slice(1);
                    document.getElementById('modalStatus').textContent = data.applicationStatus.charAt(0).toUpperCase() + data.applicationStatus.slice(1);
                    document.getElementById('modalName').textContent = data.applicationName;
                    document.getElementById('modalSex').textContent = data.applicationSex.charAt(0).toUpperCase() + data.applicationSex.slice(1);
                    document.getElementById('modalBirth').textContent = data.applicationBirth;
                    document.getElementById('modalDate').textContent = data.applicationDate;
                    
                    // Show/hide approve/reject buttons based on current status
                    const status = data.applicationStatus.toLowerCase();
                    const approveBtn = document.getElementById('approveBtn');
                    const rejectBtn = document.getElementById('rejectBtn');
                    
                    if (!approveBtn || !rejectBtn) {
                        console.error('Approve or reject buttons not found');
                        return;
                    }
                    
                    console.log('Application status:', status); // Debug log
                    
                    // Reset button states
                    approveBtn.style.display = '';
                    rejectBtn.style.display = '';
                    approveBtn.disabled = false;
                    rejectBtn.disabled = false;
                    
                    if (status !== 'pending') {
                        approveBtn.style.display = 'none';
                        rejectBtn.style.display = 'none';
                        console.log('Hiding approve/reject buttons for non-pending application'); // Debug log
                    } else {
                        console.log('Showing approve/reject buttons for pending application'); // Debug log
                    }
                    
                    // Clear any previous status messages
                    const statusMessage = document.getElementById('statusMessage');
                    if (statusMessage) {
                        statusMessage.style.display = 'none';
                        statusMessage.textContent = '';
                        statusMessage.className = 'status-message';
                    }
                    
                    // Show the modal
                    modal.show();
                } catch (error) {
                    console.error('Error in view details click handler:', error);
                }
            });
        });

        // Handle approve button click
        const approveBtn = document.getElementById('approveBtn');
        if (approveBtn) {
            approveBtn.addEventListener('click', function(e) {
                try {
                    e.preventDefault();
                    console.log('Approve button clicked');
                    console.log('Current application ID:', currentApplicationId);
                    updateApplicationStatus('approved');
                } catch (error) {
                    console.error('Error in approve button click handler:', error);
                }
            });
        }

        // Handle reject button click
        const rejectBtn = document.getElementById('rejectBtn');
        if (rejectBtn) {
            rejectBtn.addEventListener('click', function(e) {
                try {
                    e.preventDefault();
                    console.log('Reject button clicked');
                    console.log('Current application ID:', currentApplicationId);
                    updateApplicationStatus('rejected');
                } catch (error) {
                    console.error('Error in reject button click handler:', error);
                }
            });
        }

        // Function to update application status
        function updateApplicationStatus(status) {
            try {
                if (!currentApplicationId) {
                    console.error('No application ID found');
                    return;
                }

                // Debug log
                console.log('Starting status update:', {
                    applicationId: currentApplicationId,
                    status: status
                });

                // Get buttons and message elements
                const approveBtn = document.getElementById('approveBtn');
                const rejectBtn = document.getElementById('rejectBtn');
                const statusMessage = document.getElementById('statusMessage');

                if (!approveBtn || !rejectBtn || !statusMessage) {
                    console.error('Required elements not found');
                    return;
                }

                // Disable buttons while processing
                approveBtn.disabled = true;
                rejectBtn.disabled = true;

                // Show loading message
                statusMessage.textContent = 'Processing...';
                statusMessage.className = 'status-message';
                statusMessage.style.display = 'block';

                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                if (!csrfToken) {
                    console.error('CSRF token not found');
                    statusMessage.textContent = 'Error: CSRF token not found. Please refresh the page.';
                    statusMessage.className = 'status-message error';
                    return;
                }

                const url = `/update-application-status/${currentApplicationId}/`;
                
                // Debug log
                const requestDetails = {
                    url: url,
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken.value,
                        'Accept': 'application/json'
                    },
                    body: {
                        status: status
                    }
                };
                console.log('Making fetch request:', requestDetails);
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken.value,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        status: status
                    }),
                    credentials: 'same-origin'
                })
                .then(async response => {
                    const contentType = response.headers.get('content-type');
                    console.log('Response received:', {
                        status: response.status,
                        contentType: contentType,
                        url: response.url
                    });
                    
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        console.log('JSON response:', data);
                        if (!response.ok) {
                            throw new Error(data.message || `HTTP error! status: ${response.status}`);
                        }
                        return data;
                    } else {
                        // If we got HTML instead of JSON, there's likely a session/authentication error
                        const text = await response.text();
                        console.error('Received HTML instead of JSON:', text.substring(0, 200)); // Log first 200 chars
                        
                        if (response.status === 403) {
                            throw new Error('Session expired or invalid CSRF token. Please refresh the page and try again.');
                        } else if (response.status === 404) {
                            throw new Error('Application not found. Please refresh the page and try again.');
                        } else {
                            throw new Error('Unexpected server response. Please refresh the page and try again.');
                        }
                    }
                })
                .then(data => {
                    console.log('Success response:', data);
                    if (data.success) {
                        // Update UI
                        statusMessage.textContent = data.message || `Application has been ${status} successfully!`;
                        statusMessage.className = 'status-message success';
                        
                        // Update status badge in the list
                        const applicationItem = document.querySelector(`[data-application-id="${currentApplicationId}"]`)
                            .closest('.application-item');
                        if (applicationItem) {
                            const statusBadge = applicationItem.querySelector('.status-badge');
                            if (statusBadge) {
                                statusBadge.className = `status-badge status-${status}`;
                                statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                            }
                        }
                        
                        // Hide approve/reject buttons
                        approveBtn.style.display = 'none';
                        rejectBtn.style.display = 'none';
                        
                        // Update modal status
                        const modalStatus = document.getElementById('modalStatus');
                        if (modalStatus) {
                            modalStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                        }
                        
                        // Close modal and reload page after delay
                        setTimeout(() => {
                            modal.hide();
                            window.location.reload();
                        }, 2000);
                    } else {
                        throw new Error(data.message || 'Unknown error occurred');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusMessage.textContent = error.message || 'Error updating application status. Please try again.';
                    statusMessage.className = 'status-message error';
                    
                    // Re-enable buttons
                    approveBtn.disabled = false;
                    rejectBtn.disabled = false;
                });
            } catch (error) {
                console.error('Error in updateApplicationStatus:', error);
                const statusMessage = document.getElementById('statusMessage');
                if (statusMessage) {
                    statusMessage.textContent = 'An unexpected error occurred. Please try again.';
                    statusMessage.className = 'status-message error';
                    statusMessage.style.display = 'block';
                }
            }
        }
    } catch (error) {
        console.error('Error initializing dashboard:', error);
    }
});
</script>
{% endblock %} 